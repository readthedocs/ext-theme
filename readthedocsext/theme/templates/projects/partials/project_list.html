{% extends "includes/crud/list.html" %}

{% load i18n %}

{% load pagination_tags %}

{% load privacy_tags %}
{% load projects_tags %}

{% block view_binding %}data-bind="with: ProjectListView()"{% endblock view_binding %}

{% block top_left_menu_items %}
  {# Pass Django template tag specific configuration into ``ProjectListView`` #}
  <script type="application/json" data-bind="jsonInit: config">
{
  "api_url": "{% url "projects-list" %}"
}
  </script>

  {# Separate UI for the version search selection field #}
  <div class="header item">Project</div>
  <div class="active item">
    <div class="ui link search dropdown" data-bind="semanticui: {dropdown: filter_project_config()}">
      <input type="hidden" name="version" value="{{ filter.form.project.value|default:"" }}">
      <div class="default text">{% trans "All projects" %}</div>
      <i class="fa-solid fa-caret-down icon"></i>
      <div class="menu"></div>
    </div>
  </div>

  {% include "includes/filters/form.html" with fields=filter.form %}

{% endblock top_left_menu_items %}

{% block create_button %}
  <a class="ui green button" href="{{ projects_import_url }}">
    {% trans "Add Project" %}
  </a>
{% endblock %}

{% block list_placeholder_icon_class %}{% endblock %}
{% block list_placeholder_header %}
  {% trans "You don't have any projects yet" %}
{% endblock list_placeholder_header %}
{% block list_placeholder_text %}
  <div class="ui primary button">{% trans "Add your first project" %}</div>
{% endblock list_placeholder_text %}

{% block list_item_start %}
  <div class="item" data-bind="with: project({id: {{ object.id }}, url: '{% url "project-detail" object.pk %}'})">
{% endblock list_item_start %}

{% block list_item_right_menu %}
  <div class="ui small right floated buttons" data-bind="event: {mouseover: fetch}">
    <button class="ui icon button"
       data-content="{% trans "View project documentation" %}"
       data-bind="attr: {href: url_docs}, css: {disabled: loading}">
      <i class="fa-duotone fa-arrow-up-right-from-square icon"></i>
    </button>

    {% if request.user|is_admin:object %}
      <button class="ui icon dropdown button">
        <i class="fa-solid fa-ellipsis icon"></i>
        <div class="menu">
          <div class="header">{% trans "Admin" %}</div>
          <a class="item" href="{% url "projects_edit" object.slug %}">
            <i class="fa-duotone fa-wrench icon"></i>
            {% trans "Configure project" %}
          </a>
        </div>
      </button>
    {% endif %}
  </div>
{% endblock list_item_right_menu %}

{% block list_item_header %}
  <a class="ui basic label" href="{% url "projects_manage" object.slug %}">
    {{ object.name }}
  </a>

  {% if object.translations.exists %}
    <span class="ui label">
      <i class="fa-solid fa-language icon"></i>
      {% trans "Translations" %}
      <span class="detail">
        {{ object.translations.count }}
      </span>
    </span>
  {% endif %}

  {% if object.subprojects.exists %}
    <span class="ui label">
      <i class="fa-solid fa-project-diagram icon"></i>
      {% trans "Subprojects" %}
      <span class="detail">
        {{ object.subprojects.count }}
      </span>
    </span>
  {% endif %}

{% endblock list_item_header %}

{% block list_item_meta %}

  {% if object.builds.count == 0 %}
    <span class="item">
      <i class="fa-duotone fa-hourglass icon"></i>
      {% trans "No builds yets" %}
    </span>
  {% else %}
    {% with version_stable=object.get_stable_version %}
      {% with build_last=object.get_latest_build %}

        {# Show stable build #}
        {% with build=version_stable.builds.last %}
          {% if build %}
            <div class="item">
              {% include "builds/includes/status_icon.html" with build=build circular=False %}
              <span data-bind="with: create_popup">
                <a
                  class="ui basic mini compact button"
                  data-bind="popup: {}"
                  href="{% url "builds_detail" object.slug build.pk %}">
                  <code>{{ version_stable.verbose_name }} #{{ build.id }}</code>
                </a>
                {% include "includes/popupcards/build.html" with build=build %}
                <span>was built {{ build.date|timesince }} ago</span>
              </span>
            </div>
          {% endif %}
        {% endwith %}

        {% if build_last and build_last.version != version_stable %}
          {% with build=build_last %}
            <div class="item">
              {% include "builds/includes/status_icon.html" with build=build circular=False %}

              <span data-bind="with: create_popup">
                <a
                  class="ui basic mini compact button"
                  data-bind="popup: {}"
                  href="{% url "builds_detail" object.slug build.pk %}">
                  <code>{{ build.version.verbose_name }} #{{ build.id }}</code>
                </a>
                {% include "includes/popupcards/build.html" with build=build %}
                <span>was built {{ build.date|timesince }} ago</span>
              </span>
            </div>
          {% endwith %}
        {% endif %}
      {% endwith %}
    {% endwith %}
  {% endif %}

{% endblock list_item_meta %}

{# ui divided items #}

{% comment %}
  {# TESTING OLD LKDG #}
{% block list_item_right_menu_items %}
  <div class="item">
    <i class="box icon"></i>
    {% blocktrans trimmed %}
      {{ object.builds.count }} builds
    {% endblocktrans %}
  </div>
  <div class="item">
    <i class="clock outline icon"></i>
    {% blocktrans with "TODO" as date trimmed %}
      Last built {{ date }} ago
    {% endblocktrans %}
  </div>
{% endblock list_item_right_menu_items %}

{% block list_item_right_buttons %}
  {% if request.user|is_admin:project %}
    <a class="ui icon button" href="">
      <i class="wrench icon"></i>
    </a>
  {% endif %}
{% endblock list_item_right_buttons %}

{% block list_item_content %}
{% endblock list_item_content %}
{% endcomment %}
